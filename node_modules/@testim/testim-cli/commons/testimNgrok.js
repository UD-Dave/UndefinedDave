'use strict';

const { ArgError } = require('../errors.js');
const utils = require('../utils.js');
const lazyRequire = require('./lazyRequire');
const logger = require('./logger').getLogger('testimNgrok');

const WHITELISTED_TUNNEL_DOMAIN_SUFFIX = '.whitelisted-ngrok.testim.io';

let ngrokTunnelUrl = '';

const connectTunnel = async (options, authData) => {
    if (!authData.ngrokToken) {
        throw new ArgError('tunnel feature is not enabled, please contact support - info@testim.io.');
    }

    let hostname;
    if (authData.isNgrokWhitelisted) {
        hostname = `${utils.guid()}-${options.projectData.projectId}${WHITELISTED_TUNNEL_DOMAIN_SUFFIX}`;
    }

    const connectOpt = {
        proto: 'http',
        addr: options.tunnelPort || 80,
        authtoken: authData.ngrokToken,
        hostname,
    };
    if (options.tunnelHostHeader) {
        connectOpt.host_header = options.tunnelHostHeader;
    }

    const ngrok = await lazyRequire('ngrok');
    const url = await ngrok.connect(connectOpt);

    if (options.tunnelUseHttpAddress && url.startsWith('https://')) {
        logger.info('replace https to http');
        const newUrl = url.replace('https://', 'http://');

        ngrokTunnelUrl = newUrl;
    } else {
        ngrokTunnelUrl = url;
    }

    options.baseUrl = ngrokTunnelUrl;
};

const disconnectTunnel = async () => {
    if (!ngrokTunnelUrl) {
        return;
    }

    const ngrok = await lazyRequire('ngrok');
    await ngrok.disconnect(ngrokTunnelUrl);
};

module.exports = {
    connectTunnel,
    disconnectTunnel,
};
