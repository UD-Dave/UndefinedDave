'use strict';

const StepAction = require('./stepAction');
const { eyeSdkService } = require('../utils/eyeSdkService');
const logger = require('../../commons/logger').getLogger('pixel-validation-step-action');


class PixelValidationStepAction extends StepAction {
    async performAction() {
        const { shouldUseVisualGrid, applitoolsSdkConfig: config } = this.context;
        this.runContext = this.context.getRunContext(undefined);
        const eyeManager = await eyeSdkService.getManager(shouldUseVisualGrid, this.context.config.applitoolsConcurrency || 5);
        const targetElementData = this.getTarget() || {};
        try {
            const openedEye = await eyeManager.openEyes({ driver: this.driver.client, config });
            const region = (this.step.action === 'element' && targetElementData.seleniumElement) || undefined;
            await openedEye.check({ settings: { region, fully: this.step.action === 'stitched' } });
            const eyesResults = await openedEye.close();

            return { isApplitoolsSdkResult: true, success: true, eyesResults };
        } catch (err) {
            logger.error('Applitools SDK step failed', { err, info: err.info });
            return { isApplitoolsSdkResult: true, success: false, err };
        }
    }
}

module.exports = PixelValidationStepAction;
